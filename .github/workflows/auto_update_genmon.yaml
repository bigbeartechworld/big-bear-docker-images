name: "Auto Update Genmon"

# This workflow checks for updates to Genmon from jgyates/genmon GitHub releases
# and creates PRs when new versions are available

on:
  schedule:
    # Run daily at 7 AM UTC to check for updates
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check for updates even if versions match'
        required: false
        default: 'false'
        type: boolean

env:
  IMAGE_NAME: bigbeartechworld/big-bear-genmon
  DOCKERFILE_PATH: Apps/genmon

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      genmon_current: ${{ steps.current_version.outputs.version }}
      genmon_latest: ${{ steps.latest_version.outputs.version }}
      update_needed: ${{ steps.compare.outputs.update_needed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Current Version
        id: current_version
        run: |
          # Get current version from VERSION file
          CURRENT_VERSION=$(cat ${{ env.DOCKERFILE_PATH }}/VERSION)
          echo "version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Current Genmon version: ${CURRENT_VERSION}"

      - name: Get Latest Version
        id: latest_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest Genmon release from GitHub
          RELEASE_TAG=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/jgyates/genmon/releases/latest | jq -r '.tag_name')
          # Remove V prefix (V1.19.07 -> 1.19.07)
          LATEST_VERSION=$(echo "$RELEASE_TAG" | sed 's/^V//')
          echo "version=${LATEST_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Latest Genmon version: ${LATEST_VERSION}"

      - name: Compare Versions and Check Docker Hub
        id: compare
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          LATEST_VERSION="${{ steps.latest_version.outputs.version }}"
          FORCE="${{ github.event.inputs.force_check }}"

          UPDATE_NEEDED="false"

          # Compare versions
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] || [ "$FORCE" == "true" ]; then
            echo "Genmon update available: ${CURRENT_VERSION} -> ${LATEST_VERSION}"
            UPDATE_NEEDED="true"
          else
            echo "Genmon is up to date: ${CURRENT_VERSION}"
          fi

          # Check if Docker image tag exists for latest version
          if [ "$UPDATE_NEEDED" == "true" ]; then
            TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${{ env.IMAGE_NAME }}:pull" | jq -r '.token')

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${TOKEN}" \
              "https://registry-1.docker.io/v2/${{ env.IMAGE_NAME }}/manifests/${LATEST_VERSION}")

            case "$HTTP_STATUS" in
              200)
                echo "âœ… Docker image tag ${LATEST_VERSION} already exists, no update needed"
                UPDATE_NEEDED="false"
                ;;
              404)
                echo "âœ… Docker image tag ${LATEST_VERSION} does not exist, update needed"
                UPDATE_NEEDED="true"
                ;;
              *)
                echo "âš ï¸ Unexpected status ${HTTP_STATUS}, proceeding with update"
                UPDATE_NEEDED="true"
                ;;
            esac
          fi

          echo "update_needed=${UPDATE_NEEDED}" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "## Version Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Current | Latest | Update Available |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Genmon | ${{ steps.current_version.outputs.version }} | ${{ steps.latest_version.outputs.version }} | ${{ steps.compare.outputs.update_needed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update needed:** ${{ steps.compare.outputs.update_needed }}" >> $GITHUB_STEP_SUMMARY

  update-and-pr:
    name: Update and Create PR
    needs: check-updates
    if: needs.check-updates.outputs.update_needed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Dockerfile
        run: |
          cd ${{ env.DOCKERFILE_PATH }}
          # Update git clone to pin to specific release
          sed -i "s|git clone --depth 1 --branch V[0-9]\+\.[0-9]\+\.[0-9]\+ http://github.com/jgyates/genmon.git|git clone --depth 1 --branch V${{ needs.check-updates.outputs.genmon_latest }} http://github.com/jgyates/genmon.git|" Dockerfile
          # Also handle case where no branch is specified yet
          sed -i "s|git clone --depth 1 http://github.com/jgyates/genmon.git|git clone --depth 1 --branch V${{ needs.check-updates.outputs.genmon_latest }} http://github.com/jgyates/genmon.git|" Dockerfile
          echo "Updated Dockerfile to Genmon V${{ needs.check-updates.outputs.genmon_latest }}"

      - name: Update VERSION file
        run: |
          echo "${{ needs.check-updates.outputs.genmon_latest }}" > ${{ env.DOCKERFILE_PATH }}/VERSION
          echo "Updated VERSION to ${{ needs.check-updates.outputs.genmon_latest }}"

      - name: Update config.json
        run: |
          cd ${{ env.DOCKERFILE_PATH }}
          jq '.version = "${{ needs.check-updates.outputs.genmon_latest }}"' config.json > config.json.tmp
          mv config.json.tmp config.json
          echo "Updated config.json to version ${{ needs.check-updates.outputs.genmon_latest }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(genmon): update to v${{ needs.check-updates.outputs.genmon_latest }}
          branch: bot/genmon-${{ needs.check-updates.outputs.genmon_latest }}
          delete-branch: true
          title: |
            chore(genmon): update to v${{ needs.check-updates.outputs.genmon_latest }}
          body: |
            ## ðŸ”„ Automatic Update

            This PR was automatically created because a new version of Genmon was detected.

            ### Version Changes

            | Component | Previous | New |
            |-----------|----------|-----|
            | Genmon | ${{ needs.check-updates.outputs.genmon_current }} | ${{ needs.check-updates.outputs.genmon_latest }} |

            ### Files Updated
            - [x] `Dockerfile` - Git clone branch pinned to release tag
            - [x] `VERSION` - Version file
            - [x] `config.json` - Version metadata

            ### Release Notes
            - ðŸ“¦ [Genmon v${{ needs.check-updates.outputs.genmon_latest }} Release](https://github.com/jgyates/genmon/releases/tag/V${{ needs.check-updates.outputs.genmon_latest }})

            ### Testing
            After merging this PR, the build workflow will automatically:
            1. Build multi-arch Docker images (amd64, arm64)
            2. Run test suite to verify:
               - Genmon scripts exist and are executable
               - Required packages are installed
               - Web interface is accessible
            3. Push to Docker Hub with tags:
               - `${{ env.IMAGE_NAME }}:latest`
               - `${{ env.IMAGE_NAME }}:${{ needs.check-updates.outputs.genmon_latest }}`

            ---
            *ðŸ¤– This PR was automatically created by the auto-update workflow.*
          labels: |
            bot
            dependencies
            genmon
            auto-update

  notify-no-update:
    name: No Update Needed
    needs: check-updates
    if: needs.check-updates.outputs.update_needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Log Status
        run: |
          echo "No updates available"
          echo "Genmon: ${{ needs.check-updates.outputs.genmon_current }} (latest: ${{ needs.check-updates.outputs.genmon_latest }})"
          echo "All components are up to date!"
